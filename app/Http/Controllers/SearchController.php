<?php namespace App\Http\Controllers;

use App\Http\Controllers\RestResponseTrait;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Cliente;
use App\Models\Pedido;
use App\Models\PedidoNota;
use App\Models\PedidoRastreio;
use App\Models\PedidoRastreioPi;
use App\Models\PedidoProduto;
use App\Models\Produto;
use Illuminate\Support\Facades\Input;
use Carbon\Carbon;

/**
 * Class SearchController
 * @package App\Http\Controllers
 */
class SearchController extends Controller
{
    use RestResponseTrait;

    public function buscaImei()
    {
        $imei = [
            355461060906802,
            358972060251277,
            359000060583173,
            359000061039316,
            359000061040793,
            359000061054356,
            359000061059553,
            359000061138795,
            359000061139736,
            359000061140833,
            359000061149776,
            359000061158215,
            359000061497217,
            355461060910762,
            358972069652137,
            359000061037237,
            359000061039357,
            359000061047095,
            359000061054810,
            359000061062037,
            359000061139611,
            359000061140692,
            359000061149313,
            359000061153554,
            359000061159098,
            354105078591756,
            354105078672135,
            354105078675096,
            354105078675955,
            354105078700951,
            354105078709176,
            354105078720033,
            354105078721353,
            354105078728556,
            354105078730974,
            354105078732830,
            354105078738795,
            354105078739470,
            354105078740635,
            354105078741377,
            354105078742276,
            354105078742573,
            354105078743191,
            354105078744132,
            354105078761177,
            354105078772430,
            354105078787313,
            354105078793899,
            354105078797197,
            354105078799599,
            354105078821674,
            354105078826699,
            354105078851473,
            354105078853073,
            354105078860870,
            354105078645057,
            354105078674636,
            354105078675617,
            354105078684692,
            354105078706594,
            354105078715132,
            354105078720876,
            354105078725610,
            354105078730396,
            354105078731550,
            354105078737417,
            354105078739413,
            354105078739835,
            354105078740999,
            354105078741831,
            354105078742292,
            354105078742730,
            354105078743571,
            354105078746319,
            354105078766051,
            354105078786851,
            354105078787636,
            354105078796751,
            354105078799110,
            354105078810636,
            354105078823779,
            354105078847976,
            354105078852695,
            354105078859039,
            354105078881678,
            353514073560909,
            353514073561261,
            353514073641725,
            353514073642830,
            353514073643168,
            353514073561048,
            555555555555555,
            353514073563218,
            353514073642673,
            353514073643135,
            353514073560933,
            353514073561519,
            353514073641626,
            353514073642822,
            353514073643143,
            353514073560974,
            353514073563192,
            353514073641774,
            353514073643127,
            353514073560925,
            353514073561501,
            353514073563127,
            353514073641758,
            353514073642855,
            353514073643176,
            353514073561089,
            353514073563176,
            353514073641766,
            353514073643010,
            353514073643184,
            353514073368808,
            353514073371232,
            353514073425178,
            353514073425491,
            353514073425632,
            353514073468319,
            353514073468459,
            353514073468780,
            353514073371091,
            353514073424635,
            353514073425475,
            353514073425574,
            353514073468111,
            353514073468418,
            353514073468616,
            353514073371125,
            353514073424924,
            353514073425483,
            353514073425582,
            353514073468129,
            353514073468426,
            353514073468632,
            353514073471222,
            353514073471206,
            353514073469630,
            353514073371059,
            353514073423363,
            353514073425343,
            353514073425541,
            353514073468061,
            353514073468400,
            353514073468608,
            353514073370564,
            353514073423132,
            353514073425186,
            353514073425509,
            353514073468012,
            353514073468368,
            353514073468467,
            353514073371042,
            353514073423348,
            353514073425202,
            353514073425533,
            353514073468046,
            353514073468392,
            353514073468533,
            353514073471172,
            353514073468814,
            353514073471289,
            353514073471214,
            353514073526892,
            353514073570940,
            353514073571419,
            353514073571492,
            353514073571963,
            353514073570882,
            353514073570981,
            353514073571427,
            353514073571583,
            353514073572607,
            353514073570890,
            353514073571005,
            353514073571435,
            353514073571609,
            353514073572623,
            353514073570908,
            353514073571013,
            353514073571443,
            353514073571641,
            353514073572656,
            353514073570916,
            353514073571229,
            353514073571450,
            353514073571831,
            353514073573373,
            353514073570932,
            353514073571401,
            353514073571468,
            353514073571849,
            353514073573811,
            352198076669809,
            352198076671185,
            352198076671300,
            352198076670823,
            352198076671243,
            352198076611827,
            352198077283808,
            352198077458426,
            352198078281520,
            352198078282783,
            352198078283021,
            352198078283120,
            352198078284342,
            352198076613583,
            352198077424303,
            352198078280480,
            352198078282742,
            352198078282965,
            352198078283047,
            352198078283146,
            352910070964147,
            352910070987197,
            352910070989219,
            352910071151512,
            352910071158970,
            352910071159432,
            352910071160414,
            352910071161537,
            352910070965359,
            352910070987825,
            352910070989557,
            352910071158400,
            352910071159044,
            352910071160356,
            352910071161255,
            352910071746444,
            354016078303110,
            354016078309612,
            354016078317771,
            354016078320999,
            354016078326624,
            354016078327671,
            354016078328166,
            354016078328638,
            354016078335328,
            354016078341482,
            354016078342514,
            354016078344130,
            354016078344932,
            354016078355540,
            354016078302666,
            354016078309422,
            354016078311246,
            354016078320130,
            354016078326236,
            354016078327655,
            354016078327713,
            354016078328299,
            354016078334164,
            354016078341342,
            354016078341920,
            354016078343900,
            354016078344841,
            354016078353099,
            354016078356894,
            352763071707258,
            352763071713173,
            352763071982794,
            352763071983073,
            352763071983677,
            352763071983974,
            352763071985375,
            352763071994476,
            352763071996133,
            352763071707316,
            352763071713298,
            352763071982836,
            352763071983099,
            352763071983693,
            352763071983990,
            352763071985433,
            352763071995135,
            352763071996158,
            352763071707332,
            352763071982372,
            352763071982851,
            352763071983115,
            352763071983792,
            352763071984014,
            352763071985474,
            352763071995150,
            352763071996174,
            352763071712530,
            352763071982638,
            352763071983057,
            352763071983594,
            352763071983958,
            352763071985359,
            352763071994435,
            352763071996091,
            352763071707415,
            352763071982513,
            352763071982976,
            352763071983156,
            352763071983834,
            352763071984071,
            352763071985516,
            352763071995952,
            352763071996216,
            352763071708173,
            352763071982539,
            352763071982992,
            352763071983172,
            352763071983875,
            352763071984915,
            352763071985532,
            352763071995978,
            352763071996232,
            352763071709791,
            352763071982570,
            352763071983032,
            352763071983198,
            352763071983917,
            352763071985276,
            352763071985557,
            352763071996075,
            352763071707357,
            352763071982414,
            352763071982919,
            352763071983131,
            352763071983818,
            352763071984055,
            352763071985490,
            352763071995697,
            352763071996190,
            352763071882812,
            352763071883331,
            352763071936451,
            352763071937277,
            352763071937939,
            352763071938416,
            352763071939174,
            352763071883190,
            352763071931254,
            352763071936857,
            352763071937699,
            352763071938051,
            352763071938739,
            352763071882978,
            352763071930777,
            352763071936634,
            352763071937392,
            352763071937996,
            352763071938499,
            352763071882994,
            352763071931171,
            352763071936659,
            352763071937418,
            352763071938010,
            352763071938515,
            352763071883059,
            352763071931239,
            352763071936675,
            352763071937574,
            352763071938036,
            352763071938630,
            352763071882937,
            352763071883497,
            352763071936618,
            352763071937319,
            352763071937954,
            352763071938473,
            352763071939216,
            352763071883257,
            352763071931270,
            352763071937079,
            352763071937715,
            352763071938135,
            352763071939091,
            352763071883315,
            352763071932831,
            352763071937152,
            352763071937897,
            352763071938259,
            352763071939158,
            357724078982679,
            357724078979915,
            357724078983073,
            357724078982596,
            357724078983156,
            357724078986175,
            357724078986076,
            357724078941931,
            357724078986530,
            357724078986472,
            357724078985953,
            357724078986373,
            357724078986571,
            357724078979675,
            357724078979873,
            357724078982513,
            357724078982893,
            357724078982398,
            357724078985730,
            357724078985813,
            357724078980210,
            357724078982695,
            357724078980111,
            357724078980236,
            357724078979790,
            357724078986258,
            357724078986217,
            357724078962218,
            357724078986415,
            357724078986639,
            357724078986332,
            357724078985912,
            357724078979535,
            357724078979576,
            357724078978875,
            357724078982554,
            357724078983016,
            357724078984410,
            357724078985771,
            357724078986134,
            357724078656976,
            357724078651514,
            357724078651274,
            357724078651498,
            357724078656794,
            357724078656497,
            357724078656455,
            357724078656372,
            357724078656679,
            357724078656737,
            357724078650672,
            357724078651415,
            357724078650599,
            357724078651951,
            357724078651696,
            357724078654815,
            357724078650730,
            357724078650854,
            357724078654518,
            357724078654633,
            357724078658717,
            357724078658618,
            357724078658675,
            357724078659459,
            357724078652918,
            357724078656216,
            357724078656414,
            357724078657099,
            357724078651118,
            357724078651597,
            357724078657057,
            357724078656935,
            357724078656877,
            357724078654732,
            357724078655010,
            357724078655630,
            357724078655770,
            357724078656075,
            357724078650813,
            357724078650912,
            357724078671470,
            357724078671132,
            357724078669672,
            357724078672775,
            357724078672551,
            357724078673336,
            357724078673591,
            357724078675232,
            357724078674359,
            357724078657073,
            357724078651555,
            357724078656752,
            357724078651456,
            357724078656711,
            357724078650391,
            357724078656539,
            357724078656257,
            357724078656174,
            357724078656638,
            357724078650433,
            357724078651035,
            357724078651837,
            357724078651639,
            357724078651811,
            357724078654914,
            357724078650771,
            357724078654856,
            357724078654690,
            357724078654658,
            357724078658790,
            357724078655119,
            357724078659350,
            357724078659418,
            357724078653056,
            357724078655853,
            357724078656133,
            357724078651373,
            357724078651076,
            357724078651332,
            357724078656851,
            357724078657032,
            357724078654591,
            357724078654997,
            357724078654559,
            357724078656034,
            357724078656117,
            357724078650953,
            357724078650995,
            357724078651233,
            357724078671371,
            357724078671876,
            357724078672676,
            357724078672635,
            357724078672510,
            357724078671652,
            357724078673450,
            357724078675331,
            357724078676073,
            357724078672858
        ];

        foreach ($imei as $busca) {
            $find = PedidoProduto::where('imei', 'LIKE', '%'. $busca .'%')->first();
            if ($find) {
                echo $find->pedido->nota->numero . '<br>';
            } else {
                echo '0<br>';
            }
        }
    }

    /**
     * Busca de pedidos
     *
     * @return \Symfony\Component\HttpFoundation\Response
     */
    public function search()
    {
        $query = Input::get('search');

        /**
         * Pedidos
         */
        $busca = Pedido::with([
            'nota',
            'cliente',
            'rastreios', 'rastreios.rastreioRef',
            'rastreios.pedido', 'rastreios.pedido.cliente', 'rastreios.pedido.endereco',
            'rastreios.pi', 'rastreios.pi.rastreioRef',
            'rastreios.devolucao', 'rastreios.devolucao.rastreioRef',
            'rastreios.logistica', 'rastreios.logistica.rastreioRef',
        ])
            ->leftJoin('pedido_notas', 'pedidos.id', '=', 'pedido_notas.pedido_id')
            ->join('clientes', 'pedidos.cliente_id', '=', 'clientes.id')
            ->join('cliente_enderecos', 'pedidos.cliente_endereco_id', '=', 'cliente_enderecos.id')
            ->leftJoin('pedido_rastreios', 'pedidos.id', '=', 'pedido_rastreios.pedido_id')
            ->leftJoin('pedido_rastreio_pis', 'pedido_rastreios.id', '=', 'pedido_rastreio_pis.rastreio_id')
            ->leftJoin('pedido_rastreio_logisticas', 'pedido_rastreios.id', '=', 'pedido_rastreio_logisticas.rastreio_id')
            ->leftJoin('pedido_produtos', 'pedidos.id', '=', 'pedido_produtos.pedido_id')

            ->orWhere('pedidos.id', 'LIKE', '%' . $query . '%')
            ->orWhere('pedidos.codigo_marketplace', 'LIKE', '%' . $query . '%')
            ->orWhere('clientes.nome', 'LIKE', '%' . $query . '%')
            ->orWhere('cliente_enderecos.cep', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreios.rastreio', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreio_pis.codigo_pi', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreio_logisticas.autorizacao', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_produtos.imei', 'LIKE', '%' . $query . '%')

            ->groupBy('pedidos.id')
            ->orderBy('pedidos.created_at', 'DESC')

            ->get([
                'pedidos.*'
            ]);

        return $this->listResponse($busca);
    }
}
