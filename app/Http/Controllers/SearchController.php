<?php namespace App\Http\Controllers;

use App\Http\Controllers\RestResponseTrait;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Models\Cliente;
use App\Models\Pedido;
use App\Models\PedidoNota;
use App\Models\PedidoRastreio;
use App\Models\PedidoRastreioPi;
use App\Models\Produto;
use Illuminate\Support\Facades\Input;
use Carbon\Carbon;

/**
 * Class SearchController
 * @package App\Http\Controllers
 */
class SearchController extends Controller
{
    use RestResponseTrait;

    public function imei() 
    {
        $imeiBusca = [
            '357724079600577',
            '357724076240773',
            '357724076236250',
            '357724076235211',
            '357724076235237',
            '357724076235336',
            '357724076236698',
            '357724076239817',
            '357724076241599',
            '357724076243934',
            '357724076243215',
            '357724079623850',
            '357724079622191',
            '357724079624114',
            '357724076220692',
            '357724076225451',
            '357724076228596',
            '357724076227598',
            '357724076230873',
            '357724076239452',
            '357724076239056',
            '357724076241771',
            '357724076237779',
            '357724076241979',
            '357724076244296',
            '357724076225899',
            '357724079622258',
            '357724079622431',
            '357724079622555',
            '357724079617258',
            '357724079624437',
            '357724076242050',
            '357724076242191',
            '357724076236193',
            '357724079617498',
            '357724079523837',
            '357724076240310',
            '357724076240377',
            '357724076237019',
            '357724076239650',
            '357724076239973',
            '357724076237035',
            '357724076240732',
            '357724076240690',
            '357724076234438',
            '357724076234677',
            '357724076241375',
            '357724076236532',
            '357724076241292',
            '357724076244213',
            '357724076244171',
            '357724076229719',
            '357724076231533',
            '357724076224736',
            '357724076234032',
            '357724076233133',
            '357724076531932',
            '357724076534019',
            '357724076532278',
            '357724076232671',
            '357724076231954',
            '357724076240278',
            '357724076240492',
            '357724076239932',
            '357724076234230',
            '357724076234354',
            '357724076236912',
            '357724076237993',
            '357724076235971',
            '357724079600510',
            '357724076240872',
            '357724076235815',
            '357724076235534',
            '357724076235278',
            '357724076228513',
            '357724076241631',
            '357724076235013',
            '357724076243751',
            '357724076243991',
            '357724076231798',
            '357724079624015',
            '357724079624239',
            '357724076225071',
            '357724076225196',
            '357724076225352',
            '357724076231897',
            '357724076224611',
            '357724076239338',
            '357724076239114',
            '357724076239510',
            '357724076241698',
            '357724076236854',
            '357724076244338',
            '357724076225337',
            '357724076225774',
            '357724079622076',
            '357724079622290',
            '357724079624296',
            '357724079624379',
            '357724079624395',
            '357724076242274',
            '357724076240138',
            '357724079617555',
            '357724079523894',
            '357724079624056',
            '357724076240435',
            '357724076240617',
            '357724076239593',
            '357724076240039',
            '357724076240070',
            '357724076237092',
            '357724076240658',
            '357724076229057',
            '357724076234636',
            '357724076234594',
            '357724076241235',
            '357724076241094',
            '357724076244270',
            '357724076244130',
            '357724076244072',
            '357724076229099',
            '357724076230998',
            '357724076232135',
            '357724076232077',
            '357724076232630',
            '357724076534373',
            '357724076532732',
            '357724076232358',
            '357724076224991',
            '357724076226855',
            '357724076240195',
            '357724076240559',
            '357724076232218',
            '357724076234156',
            '357724076234115',
            '357724076236417',
            '357724076238058'
        ];
        $imei = array_merge([], $imeiBusca);

        set_time_limit(0);

        $remove = [];
        $achou  = [];
        $files = glob(storage_path('app/public/nota/*.xml'));
        foreach ($files as $nota) {
            $output = file_get_contents($nota);
            if (substr($output, 0, 5) !== '<?xml')
                continue;

            $xml = simplexml_load_string($output);

            $nfe = $xml->NFe->infNFe;

            if (!is_object($nfe))
                continue;
            
            if ($nfe->emit->CNPJ != '14619408000150')
                continue;

            $find     = false;
            $uf       = null;
            $idPedido = null;
            $buscaI   = null;
            foreach ($imei as $busca) {
                if (!property_exists($nfe, 'infAdic'))
                    break;

                if (strpos(strtoupper($nfe->infAdic->infCpl), $busca) !== false) {
                    $chave = $xml->protNFe->infProt->chNFe;
                    $idPedido = (int) substr($chave, 25, 10);
                    $achou[$busca]  = $busca . ';' . $nfe->dest->enderDest->UF . ';' . $idPedido . '<br>';
                    unset($imei[array_search($busca, $imei)]);

                    // break;
                 }
            }

            // break;
        }

        foreach ($imeiBusca as $teste) {
            if (array_key_exists($teste, $achou)) {
                echo $achou[$teste];
            } else {
                echo $teste . '<br>';
            }
        }

        // echo implode('', array_reverse($achou));
        print_r($imei);
    }

    public function devolucao()
    {
        $devolucoes = [
            '146011',
            '146041',
            '146051',
            '146671',
            '146681',
            '146691',
            '146701',
            '146711',
            '146721',
            '146731',
            '146751',
            '146771',
            '146791',
            '146811',
            '146861',
            '147221',
            '147251',
            '147261',
            '147271',
            '147981',
            '148721',
            '148741',
            '148751',
            '148761',
            '148791',
            '148801',
            '149351',
            '149961',
            '150741',
            '150851',
            '152051',
            '152211',
            '152221',
            '152231',
            '152241',
            '152251',
            '152261',
            '152271',
            '152281',
            '152601',
            '152641',
            '152991',
            '153061',
            '153071',
            '153081',
            '153101',
            '153121',
            '153131',
            '153151',
            '153161',
            '153251',
            '153391',
            '153401',
            '153551',
            '153601',
            '153621',
            '153631',
            '153671',
            '153751',
            '153871',
            '153901',
            '153921',
            '154031',
            '158811',
            '158841',
            '158851',
            '158871',
            '158881',
            '158911',
            '158941',
            '158951',
            '158971',
            '158991',
            '159221',
            '159541',
            '159831',
            '159841',
            '159891',
            '160651',
            '161791',
            '162621',
            '162711',
            '163281',
            '163501',
            '163511',
            '164851',
            '166391',
            '166511',
            '166541',
            '166891',
            '167301',
            '167311',
            '167321',
            '167771',
            '167781',
            '167791',
            '167801',
            '167811',
            '167971',
            '167981',
            '167991',
            '168001',
            '169711',
            '170861',
            '170871',
            '170941',
            '170971',
            '171021',
            '171081',
            '172771',
            '172781',
            '172791',
            '172801',
            '173161',
            '173191',
            '173221',
            '173251',
            '173271',
            '174471',
            '174561',
            '176141',
            '176181',
            '176201',
            '176231',
            '176261',
            '176281',
            '177751',
            '180181',
            '180271',
            '180301',
            '180361',
            '180411',
            '180471',
            '180531',
            '180561',
            '180581',
            '180591',
            '180601',
            '180611',
            '180621',
            '180711',
            '181351',
            '181391',
            '181411',
            '181861',
            '181891',
            '182491',
            '182511',
            '182531',
            '182571',
            '182581',
            '182731',
            '183561',
            '183571',
            '183581',
            '183591',
            '183601',
            '183661',
            '183841',
            '184641',
            '184661',
            '184671',
            '184711',
            '184721',
            '184731',
            '184931',
            '184951',
            '184961',
            '184981',
            '184991',
            '185031',
            '185631',
            '185761',
            '185821',
            '186111',
            '186221',
            '186231',
            '186251',
            '186261',
            '186271',
            '186281',
            '186291',
            '186301',
            '186681',
            '186691',
            '186711',
            '186731',
            '186741',
            '186751',
            '186761',
            '186781',
            '186791',
            '186801',
            '186891',
            '186931',
            '186941',
            '186991',
            '187001',
            '187031',
            '188321',
            '188331',
            '188341',
            '188351',
            '188361',
            '188371',
            '188381',
            '188391',
            '188401',
            '188411',
            '188421',
            '188431',
            '188441',
            '188451',
            '188461',
            '188471',
            '188481',
            '188491',
            '188501',
            '188511',
            '190021',
            '190031',
            '190971',
            '190981',
            '190991',
            '191651',
            '193591',
            '193631',
            '193711',
            '194041',
            '196731',
            '196771',
            '196911',
            '196941',
            '196951',
            '196971',
            '197021',
            '197041',
            '197051',
            '197771',
            '197811',
            '198061',
            '198781',
            '199381',
            '199391',
            '199951',
            '200071',
            '200411',
            '200431',
            '200441',
            '200511',
            '200521',
            '200871',
            '200981',
            '201011',
            '201021',
            '201031',
            '201051',
            '201091',
            '201121',
            '201131',
            '201391',
            '201471',
            '201511',
            '201681',
            '201691',
            '201701',
            '201711',
            '201721',
            '201741',
            '201751',
            '201761',
            '202161',
            '203181',
            '203401',
            '203441',
            '203451',
            '203811',
            '205581',
            '205601',
            '205621',
            '205631',
            '205641',
            '205651',
            '206991',
            '207001',
            '207011',
            '207021',
            '207031',
            '207041',
            '207051',
            '207431',
            '207441',
            '207451',
            '207461',
            '207471',
            '207481',
            '207491',
            '207501',
            '208051',
            '208921',
            '208931',
            '208941',
            '208951',
            '208961',
            '208971',
            '208981',
            '208991',
            '209001',
            '209011',
            '210211',
            '211411',
            '211421',
            '211431',
            '211441',
            '211451',
            '211471',
            '211481',
            '211491',
            '211501',
            '211521',
            '211531',
            '211711',
            '212381',
            '212481',
            '212671',
            '212681',
            '212691',
            '212701',
            '212711',
            '212721',
            '212731',
            '212741',
            '212751',
            '212761',
            '212771',
            '212781',
            '212801',
            '212811',
            '213291',
            '213411',
            '213781',
            '213791',
            '213801',
            '213821',
            '213831',
            '213841',
            '213851',
            '213871',
            '213961',
            '214071',
            '214381',
            '214401',
            '214431',
            '214691',
            '214701',
            '214721',
            '215241',
            '215381',
            '215991',
            '216521',
            '216531',
            '216541',
            '216551',
            '216561',
            '216581',
            '219931',
            '219941',
            '219951',
            '219961',
            '219971',
            '219981',
            '219991',
            '220001',
            '220631',
            '220641',
            '220661',
            '220671',
            '220681',
            '223691',
            '223941',
            '223951',
            '224171',
            '224751',
            '224761',
            '224771',
            '224781',
            '224791',
            '224821',
            '225371',
            '225381',
            '225401',
            '226541',
            '226561',
            '226571',
            '226581',
            '226591',
            '226601',
            '226611',
            '226621',
            '226631',
            '226641',
            '226651',
            '226661',
            '226671',
            '226721',
            '226731',
            '226741',
            '229181',
            '229191',
            '229201',
            '229211',
            '229221',
            '229231',
            '229241',
            '229251',
            '229261',
            '229271',
            '229281',
            '229291',
            '229301',
            '229311',
            '229321',
            '232761',
            '232771',
            '232781',
            '232801',
            '232811',
            '236251',
            '236271',
            '241471',
            '241651',
            '241661',
            '242391',
            '242801',
            '242811',
            '242841',
            '242851',
            '242861',
            '242871',
            '242881',
            '242891'
        ];

        foreach ($devolucoes as $dev) {
            $arquivo = glob(storage_path('app/public/nota/*14619408000150550010000') . $dev . '*.xml');
            if (sizeof($arquivo) == 0)
                continue;
            
            $output = file_get_contents($arquivo[0]);
            preg_match('/Referente a Nota Fiscal:\ ?[0-9]{4,5}/', $output, $notaVenda);

            $pedido = Pedido::with(['nota', 'produtos', 'endereco'])
                ->where('id', '=', $dev)
                ->first();

            if (!$pedido) {
                echo $dev . '<br>';
                continue;
            }

            if (sizeof($notaVenda) == 0) {
                preg_match('/nÃºmero:\ ?[0-9]{4,5}/', $output, $notaVenda);
            }

            if (sizeof($notaVenda) > 0) {
                echo '"' . $dev . 
                    '","' . str_replace(':', '', substr($notaVenda[0], -5)) . 
                    '","' . Carbon::createFromFormat('Y-m-d', $pedido->nota->data)->format('d/m/Y') .
                    '","R$' . number_format($pedido->total * -1, 2, ',', '.') .
                    '","' . $pedido->produtos[0]->produto->titulo .
                    '","' . $pedido->endereco->uf . '"<br>';
            } else {
                echo '"' . $dev . 
                    '","' . 'SEM VENDA' . 
                    '","' . Carbon::createFromFormat('Y-m-d', $pedido->nota->data)->format('d/m/Y') .
                    '","R$' . number_format($pedido->total * -1, 2, ',', '.') .
                    '","' . $pedido->produtos[0]->produto->titulo .
                    '","' . $pedido->endereco->uf . '"<br>';
            }
        }
    }

    /**
     * Busca de pedidos
     *
     * @return \Symfony\Component\HttpFoundation\Response
     */
    public function search()
    {
        $query = Input::get('search');

        /**
         * Pedidos
         */
        $busca = Pedido::with([
            'nota',
            'cliente',
            'rastreios', 'rastreios.rastreioRef',
            'rastreios.pedido', 'rastreios.pedido.cliente', 'rastreios.pedido.endereco',
            'rastreios.pi', 'rastreios.pi.rastreioRef',
            'rastreios.devolucao', 'rastreios.devolucao.rastreioRef',
            'rastreios.logistica', 'rastreios.logistica.rastreioRef',
        ])
            ->join('pedido_notas', 'pedidos.id', '=', 'pedido_notas.pedido_id')
            ->join('clientes', 'pedidos.cliente_id', '=', 'clientes.id')
            ->join('cliente_enderecos', 'pedidos.cliente_endereco_id', '=', 'cliente_enderecos.id')
            ->leftJoin('pedido_rastreios', 'pedidos.id', '=', 'pedido_rastreios.pedido_id')
            ->leftJoin('pedido_rastreio_pis', 'pedido_rastreios.id', '=', 'pedido_rastreio_pis.rastreio_id')
            ->leftJoin('pedido_rastreio_logisticas', 'pedido_rastreios.id', '=', 'pedido_rastreio_logisticas.rastreio_id')
            ->leftJoin('pedido_produtos', 'pedidos.id', '=', 'pedido_produtos.pedido_id')

            ->orWhere('pedidos.id', 'LIKE', '%' . $query . '%')
            ->orWhere('pedidos.codigo_marketplace', 'LIKE', '%' . $query . '%')
            ->orWhere('clientes.nome', 'LIKE', '%' . $query . '%')
            ->orWhere('cliente_enderecos.cep', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreios.rastreio', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreio_pis.codigo_pi', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_rastreio_logisticas.autorizacao', 'LIKE', '%' . $query . '%')
            ->orWhere('pedido_produtos.imei', 'LIKE', '%' . $query . '%')

            ->groupBy('pedidos.id')
            ->orderBy('pedidos.created_at', 'DESC')

            ->get([
                'pedidos.*'
            ]);

        return $this->listResponse($busca);
    }
}
